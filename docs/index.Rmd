---
title: "Predicting Default Rates"
author: "Francisco J. Buenrostro"
date: "2024-07-15"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

## Introduction

In this example, we will explore a data set that contains information on
default payments, demographic factors, credit data, history of payment,
and bill statements of credit card clients in Taiwan from April 2005 to
September 2005.

This data set was obtained from the University of California, Irvine
archives.

Source:
<https://archive.ics.uci.edu/ml/datasets/default+of+credit+card+clients>

The Default of Credit Card Clients data set will allow us to practice
key data skills. The first, is **data acquisition**, by obtaining and
importing our data into RStudio. The second, is **data preparation**, by
cleaning and manipulating the variables within the data set to prepare
for the analytics portion of the project. The third, is **data
analytics**, using statistics, logistical regression, and predictive
models to uncover insights into our dependent and independent variables.
The last data skill we will use is **data visualization**, by creating
charts and graphs throughout the project to better portray what is
happening within the data.

## Project Goals

### Goal 1:

Employ exploratory data analytics techniques on the data set to uncover
new insights.

### Goal 2:

Run a logistical regression to predict the probability of a new credit
card client defaulting on their next month's credit card payment.

### Goal 3:

Run a "PCA" Principal Component Analysis on the data set and observe how
the first 5 principal components load all of the variables.

### Goal 4:

Run a K-Means cluster on the data with k = 4, plot charts using
different variables, and explain the 4 types of clusters in the charts.

## Variable Name + Description

There are 25 variables.

**ID:** ID of each client

**LIMIT_BAL:** Amount of given credit in NT dollars (includes individual
and family/supplementary credit

**SEX:** Gender (1=male, 2=female)

**EDUCATION:** (1=graduate school, 2=university, 3=high school,
4=others, 5=unknown, 6=unknown)

**MARRIAGE:** Marital status (1=married, 2=single, 3=others) AGE: Age in
years

**PAY_0:** Repayment status in September, 2005 (-2=pay fully for the
balance, -1=pay at least for the minimum requirement, 0=payment delay
for one month, 1=payment delay for two months, ... 7=payment delay for
eight months, 8=payment delay for nine months and above)

**PAY_2:** Repayment status in August, 2005 (scale same as above)

**PAY_3:** Repayment status in July, 2005 (scale same as above)

**PAY_4:** Repayment status in June, 2005 (scale same as above)

**PAY_5:** Repayment status in May, 2005 (scale same as above)

**PAY_6:** Repayment status in April, 2005 (scale same as above)

**BILL_AMT1:** Amount of bill statement in September, 2005 (NT dollar)

**BILL_AMT2:** Amount of bill statement in August, 2005 (NT dollar)

**BILL_AMT3:** Amount of bill statement in July, 2005 (NT dollar)

**BILL_AMT4:** Amount of bill statement in June, 2005 (NT dollar)

**BILL_AMT5:** Amount of bill statement in May, 2005 (NT dollar)

**BILL_AMT6:** Amount of bill statement in April, 2005 (NT dollar)

**PAY_AMT1:** Amount of previous payment in September, 2005 (NT dollar)

**PAY_AMT2:** Amount of previous payment in August, 2005 (NT dollar)

**PAY_AMT3:** Amount of previous payment in July, 2005 (NT dollar)

**PAY_AMT4:** Amount of previous payment in June, 2005 (NT dollar)

**PAY_AMT5:** Amount of previous payment in May, 2005 (NT dollar)

**PAY_AMT6:** Amount of previous payment in April, 2005 (NT dollar)

**default.payment.next.month:** Default payment (1=yes, 0=no)

## Exploring the Data

First, Let us load the data into R and take an initial look at what we
are dealing with. the str() function will allow us to compactly display
the internal structure of our data set "credit1". the summary() function
will allow us to view a statistical summary of each of the variables we
are dealing with.

```{r}
credit1 = read.csv("creditcard.csv")
str(credit1)
summary(credit1)
```

### Missing Values & Unwanted Variables

The next step is to find out if we have any missing value, or if we will
need to preform other types of data management.

```{R}
library(dplyr)
missing = credit1 %>% summarise_all(funs(sum(is.na(.))/n()))
missing
# Lets remove the ID variable it is not needed
credit=credit1[,-1]
```

### Data Visualizations

Now lets create some data visualizations to learn more about the data.
The first visualization will look at the percentage of clients who have
not defaulted vs the those who have defaulted.

```{R}
library(ggplot2)
credit %>% 
  group_by(default.payment.next.month) %>% 
  summarise(Count = n())%>% 
  mutate(percent = prop.table(Count)*100)%>%
  ggplot(aes(reorder(default.payment.next.month, -percent), percent), fill = default.payment.next.month)+
  geom_col(fill = c("grey", "light blue"))+
  geom_text(aes(label = sprintf("%.1f%%", percent)), hjust = 0.2, vjust = 2, size = 5)+ 
  theme_bw()+  
  xlab("Default (0:No, 1:Yes)") + ylab("Percent") + ggtitle("Default Percent")
```

### Comment

We see that 22.1% of clients have defaulted on their monthly payment and
77.9% of clients have not.

### Visuals Continued

```{R}
library(ggplot2)
ggplot(credit, aes(x = LIMIT_BAL)) + geom_histogram()
```

### LIMIT_BAL Histogram Comment

If we look at the Histogram using our LIMIT_BAL variable it shows us the
number of clients with a given credit balance in Taiwan Dollars. We can
see that there is a large amount of clients with lower credit balances
and a lower number of clients with higher credit amounts.

```{R}
library(ggplot2)
ggplot(credit, aes(x = SEX)) + geom_histogram()
ggplot(credit, aes(x = EDUCATION)) + geom_histogram()
ggplot(credit, aes(x = MARRIAGE)) + geom_histogram()
ggplot(credit, aes(x = AGE)) + geom_histogram()
```

### AGE Histogram Comment

If we look at the Histogram using our AGE variable it shows us the
number of credit card clients by age. We can see that the majority of
clients are younger than 40 years of age.

```{R}
library(ggplot2)
ggplot(credit, aes(x = PAY_0)) + geom_histogram()
ggplot(credit, aes(x = PAY_2)) + geom_histogram()
table(credit$PAY_0)
```

### Data Management

Here we will preform some data management by combining variables that
have a low number of observations with other variables that have low
numbers of observations. We will also create some visuals for the new
combined variables as well as turn some numeric variables into factors.
This is so that we are able to run our logistical regression in the next
steps.

```{R}
# There are some catergories with very few observations. Let's group them together.
credit$EDUCATION[credit$EDUCATION == 0] = 4
credit$EDUCATION[credit$EDUCATION == 5] = 4
credit$EDUCATION[credit$EDUCATION == 6] = 4
credit$MARRIAGE[credit$MARRIAGE == 0] = 3

ggplot(credit, aes(x = EDUCATION)) + geom_histogram()
ggplot(credit, aes(x = MARRIAGE)) + geom_histogram()

# Make some numeric variables into factors
credit$default.payment.next.month=as.factor(credit$default.payment.next.month)
credit$SEX=as.factor(credit$SEX) 
credit$EDUCATION=as.factor(credit$EDUCATION)
credit$MARRIAGE=as.factor(credit$MARRIAGE)
```

### Exploratory Data Analysis

Let us explore our data a little bit more. In this section we will run
some simple EDA "Exploratory Data Analysis" by using ggplot to create
some bar charts, box plot, and violin charts. This will help us better
understand our data.

### Bar Chart

In the bar charts there are two components the first being the variable
that we are observing which is on the X - axis, and the second is if the
client defaulted on their monthly payment where the salmon color means
no, and the blue means yes.

If we take a look at the education bar chart where, 1 = graduate school,
2 = university, 3 = high school, and 4 = other. We can see that the
majority of the credit card clients have a university degree or higher.
We can also see the split between clients who did not default on their
payment an clients who did default on their payment relative to the
category the client falls under.

### Violin and Box Chart

If we look at the violin and box charts. The first thing we notice is
that we have separated the clients who have defaulted on their credit
card payment from those who did not. We did this to compare the two
groups to each other.

In the violin and box charts, like the bar charts, are made up of
multiple components. This time our variable we are observing is on the
Y - axis. The first part of our visual insights is the violin, or blob
looking portion of the chart. This part of the chart allows us to see
the density of observations as we move up from 0. The wider the blob the
greater the number of observations, the narrower the blob the lesser the
number of observations. The second part, is the box plot which allows us
to see the median, upper quartile, lower quartile, and both upper and
lower extremes. The last part is if the client defaulted on their
monthly payment where the salmon color means no, and the blue means yes.

Lets take a look at the characteristics of the clients who did not
default on their payment compared to those of the clients who did using
our limit_bal variable. The first thing to make note of is that the
group that defaulted has a wider base, letting us know that there was a
large amount of clients who defaulted with lower credit limits available
to them. The second thing we notice is that the group that did not
default has more clients with larger credit limits and an outlier with a
really high credit limit compared to the default group.

```{R}
# Some EDA
# Default against categorical variables
ggplot(credit, aes(x=SEX,fill=default.payment.next.month))+ geom_bar()+ theme_bw() 
ggplot(credit, aes(x=EDUCATION,fill=default.payment.next.month))+ geom_bar()+theme_bw()
ggplot(credit, aes(x=MARRIAGE,fill=default.payment.next.month))+ geom_bar()+theme_bw()

# Default against numeric variables
ggplot(credit, aes(x=default.payment.next.month, y=LIMIT_BAL, fill=default.payment.next.month)) + geom_violin()+
  geom_boxplot(width=0.1, fill="white") + labs(title="Amount of given credit in NT dollars")
ggplot(credit, aes(x=default.payment.next.month, y=AGE, fill=default.payment.next.month)) + geom_violin()+
  geom_boxplot(width=0.1, fill="white") + labs(title="Age")
ggplot(credit, aes(x=default.payment.next.month, y=PAY_0, fill=default.payment.next.month)) + geom_violin()+
  geom_boxplot(width=0.1, fill="white") + labs(title="Repayment status in September, 2005")
ggplot(credit, aes(x=default.payment.next.month, y=BILL_AMT1, fill=default.payment.next.month)) + geom_violin()+
  geom_boxplot(width=0.1, fill="white") + labs(title="Amount of bill statement in September, 2005 (NT dollar)")+
  ylim(0,125000)
ggplot(credit, aes(x=default.payment.next.month, y=PAY_AMT1, fill=default.payment.next.month)) + geom_violin()+
  geom_boxplot(width=0.1, fill="white") + labs(title="Amount of previous payment in September, 2005 (NT dollar)")+
  ylim(0,10000)
```

### The Logistical Regression

Now that we have conducted all of our data management, and exploratory
data analysis. The next part of our project is to conduct a logistical
regression. We use a logistical regression because we want to know if
the client will 1, default on their payment, or 0, will not default on
their payment. With a logistical regression we are able to model what
influence the independent variables have on the dependent variable
default.payment.next.month if there is an influence then this allows us
to predict how likely a client is to default on their next months credit
card payment based on their characteristics.

```{R}
# Logistic model
logit.1 = glm(default.payment.next.month~., data=credit, family="binomial")
summary(logit.1)

```

### Predicting Credit Default Rates

Using our logistical model logit.1, we will predict the likely hood of a
client defaulting on their next months credit card payment.

```{R}
pred = predict(logit.1, type = "response", credit)
summary(pred)
```

### "ROC" Reciver Operating Characteristic and "AUC" Area Under the Curve

Let's create a visual for the ROC curve with the AUC value displayed.
The ROC curve in logistical regression is used for determining the best
cutoff value for predicting whether a new observation in this case a
client will "default on their payment" (1) or a "not default on their
payment" (0). The ideal location for the ROC is in the top left corner
which is a high true positive rate and low false positive rate. The AUC
is an aggregated metric that evaluates how well a logistic regression
model classifies positive and negative outcomes at all possible cutoffs.
The closer the value is to 1 the better.

```{r}
# ROC and AUC-
library(pROC)
glm.roc = roc(response = credit$default.payment.next.month, predictor = pred)
plot(glm.roc, legacy.axes = TRUE, print.auc.y = 1.0, print.auc = TRUE)
coords(glm.roc, "best", "threshold")

library(caret)
# Threshold = 0.5
pred_default = factor(ifelse(pred >=0.5, "Yes", "No"))
credit$default.payment.next.month = factor(ifelse(credit$default.payment.next.month==1, "Yes","No"))
confusionMatrix (pred_default, credit$default.payment.next.month, positive = "Yes")
```

### Confusion Matrix Interpretation

The confusion matrix shows us that model was able to predict 81.1% of
the clients who defaulted on their next month's credit card payment
based on the past characteristics of the independent variables.

### Searching for a Better Threshold using Two Methods

Next we want to know if the original threshold we selected was the best
threshold at .5 or could we have chosen a different cutoff point to get
better results? To find a better threshold we will create a chart which
plots out the sensitivity, specificity, and accuracy curves for the
model above. The value will be on the Y - axis between 0 and 1. On the
X - axis will be the possible cut offs between 0 to 1.

### Optimal Cutoff

The optimal Cutoff is at the intersection of the sensitivity and
specificity curves.

In our case the threshold we selected was .5 and from reviewing the
chart we can see that the optimal cut off is between .2 and .3. We could
improve our results by decreasing our cutoff point to one between .2 and
.3.

```{r}
# In search of a better threshold
perform_fn = function(cutoff) 
{
  pred_default = factor(ifelse(pred >= cutoff, "Yes", "No"))
  conf <- confusionMatrix(pred_default, credit$default.payment.next.month, positive = "Yes")
  accuray <- conf$overall[1]
  sensitivity <- conf$byClass[1]
  specificity <- conf$byClass[2]
  out <- t(as.matrix(c(sensitivity, specificity, accuray))) 
  colnames(out) <- c("sensitivity", "specificity", "accuracy")
  return(out)
}

s = seq(0.01,0.99,length=100)
OUT = matrix(0,100,3)

for(i in 1:100)
{
  OUT[i,] = perform_fn(s[i])
} 

plot(s, OUT[,1],xlab="Cutoff",ylab="Value",cex.lab=1.5,cex.axis=1.5,ylim=c(0,1),
     type="l",lwd=3,axes=FALSE,col=2)
axis(1,seq(0,1,length=5),seq(0,1,length=5),cex.lab=1.5)
axis(2,seq(0,1,length=5),seq(0,1,length=5),cex.lab=1.5)
lines(s,OUT[,2],col="darkgreen",lwd=3)
lines(s,OUT[,3],col=4,lwd=3)
box()
legend("right",col=c(2,"darkgreen",4,"darkred"),text.font =3,inset = 0.02,
       box.lty=0,cex = 0.8, 
       lwd=c(2,2,2,2),c("Sensitivity","Specificity","Accuracy"))
abline(v = 0.5, col="black", lwd=2, lty=2)
abline(v = 0.3, col="black", lwd=2, lty=3)
abline(v = 0.2, col="black", lwd=2, lty=4)
axis(1, at = seq(0.1, 1, by = 0.1))
grid()
```

### Conducting "PCA" Principal Component Analysis

In this part of our analysis we will conduct a "PCA" or principal
component analysis.

```{r}
## Remove the dependent variable
credit2=credit1[!names(credit1) %in% c("ID","default.payment.next.month")]

# Principal Component Analysis
str(credit2)  # Make sure all variables are numerical
pr.out=prcomp(credit2, scale=TRUE)
summary(pr.out)
pr.out$rotation[,1:5]
```

```{r include=FALSE}
pr.out$x
```

### K-Means Cluster for Classification

text

```{r include=FALSE}
## K-Means Cluster
km1=kmeans(credit2,4,nstart=111)
km1$cluster
```

```{r}
plot(credit2[,c("LIMIT_BAL","BILL_AMT1")], col=(km1$cluster+1), 
     main="K-Means Clustering Results with K=4", 
     xlab="LIMIT_BAL", ylab="BILL_AMT1", pch=20, cex=2)

plot(credit2[,c("LIMIT_BAL","PAY_AMT1")], col=(km1$cluster+1), 
     main="K-Means Clustering Results with K=4", 
     xlab="LIMIT_BAL", ylab="PAY_AMT1", pch=20, cex=2)

plot(credit2[,c("PAY_AMT1","BILL_AMT1")], col=(km1$cluster+1), 
     main="K-Means Clustering Results with K=4", 
     xlab="PAY_AMT1", ylab="BILL_AMT1", pch=20, cex=2)

plot(credit2[,c("LIMIT_BAL","AGE")], col=(km1$cluster+1), 
     main="K-Means Clustering Results with K=4", 
     xlab="LIMIT_BAL", ylab="AGE", pch=20, cex=2)

plot(credit2[,c("BILL_AMT1","AGE")], col=(km1$cluster+1), 
     main="K-Means Clustering Results with K=4", 
     xlab="BILL_AMT1", ylab="AGE", pch=20, cex=2)
```

### Conclusion

The Default of Credit Card Clients data set allowed us to practice key
data skills. The first was data acquisition, by obtaining and importing
our data into RStudio. The second was data preparation, by cleaning and
manipulating the variables within the data set to prepare for the
analytics portion of the project. The third was the data analytics
phase, using statistics, logistical regression, and predictive models to
uncover insights into our dependent and independent variables. the last
data skill we practiced was data visualization, by creating charts and
graphs throughout the project to better portray what was happening
within the data.
